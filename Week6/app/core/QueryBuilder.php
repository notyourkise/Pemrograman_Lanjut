<?php
class QueryBuilder{private mysqli $db;private string $select='*';private string $from='';private array $w=[],$p=[],$t=[];private ?string $ob=null;private ?int $l=null,$o=null;public function __construct(?mysqli $db=null){$this->db=$db?:Database::getConnection();}public function select(string $s):self{$this->select=$s;return $this;}public function from(string $f):self{$this->from=$f;return $this;}public function where(string $c,string $ty='', $v=null):self{$this->w[]=$c;if($ty!==''&&$v!==null){$this->t[]=$ty;$this->p[]=$v;}return $this;}public function orderBy(string $o):self{$this->ob=$o;return $this;}public function limit(int $l):self{$this->l=$l;return $this;}public function offset(int $o):self{$this->o=$o;return $this;}public function get():array{$sql=$this->toSql();$st=$this->prep($sql);$st->execute();$res=$st->get_result();$rows=[];while($r=$res->fetch_assoc()){$rows[]=$r;}$st->close();return $rows;}public function first():?array{$this->limit(1)->offset(0);$r=$this->get();return $r[0]??null;}public function count(string $expr='COUNT(*) as c'):int{$orig=$this->select;$this->select=$expr;$sql=$this->toSql();$st=$this->prep($sql);$st->execute();$res=$st->get_result();$c=(int)($res->fetch_assoc()['c']??0);$st->close();$this->select=$orig;return $c;}private function toSql():string{$sql='SELECT '.$this->select.' FROM '.$this->from; if($this->w){$sql.=' WHERE '.implode(' AND ',$this->w);} if($this->ob){$sql.=' ORDER BY '.$this->ob;} if($this->l!==null){$sql.=' LIMIT ?';$this->t[]='i';$this->p[]=$this->l;} if($this->o!==null){$sql.=' OFFSET ?';$this->t[]='i';$this->p[]=$this->o;} return $sql;}private function prep(string $sql):mysqli_stmt{$st=$this->db->prepare($sql);if($this->p){$types=implode('',$this->t);$refs=[];$refs[]=&$types;foreach($this->p as $k=>$v){$refs[]=&$this->p[$k];}call_user_func_array([$st,'bind_param'],$refs);}return $st;}}